<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Biblioteca Integrado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Sistema de Gerenciamento de Biblioteca Integrado</h1>
            <p class="subtitle">SGBU - M√≥dulos Integrados</p>
        </header>

        <!-- Estat√≠sticas Gerais -->
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">Total de Livros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.disponivel }}</div>
                <div class="stat-label">Dispon√≠veis</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.emprestado }}</div>
                <div class="stat-label">Emprestados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ usuarios|length }}</div>
                <div class="stat-label">Usu√°rios</div>
            </div>
        </section>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('usuarios')">üë• Usu√°rios</button>
            <button class="nav-tab" onclick="showTab('livros')">üìò Livros</button>
            <button class="nav-tab" onclick="showTab('emprestimos')">üîó Empr√©stimos</button>
            <button class="nav-tab" onclick="showTab('relatorios')">üìä Relat√≥rios</button>
        </div>

        <!-- Mensagem de Feedback -->
        <div id="mensagem" class="mensagem"></div>

        <!-- TAB: USU√ÅRIOS -->
        <div id="tab-usuarios" class="tab-content active">
            <section class="form-section">
                <h3>‚ûï Cadastrar Novo Usu√°rio</h3>
                <form id="formCadastro">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome Completo *</label>
                            <input type="text" id="nome" name="nome" required 
                                   minlength="1" maxlength="100" 
                                   placeholder="Ex: Jo√£o Silva">
                        </div>
                        <div class="form-group">
                            <label for="matricula">Matr√≠cula *</label>
                            <input type="text" id="matricula" name="matricula" required 
                                   minlength="5" maxlength="20" 
                                   placeholder="Ex: ALU12345">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipo">Tipo de Usu√°rio *</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="ALUNO">üéì Aluno</option>
                                <option value="PROFESSOR">üë®‚Äçüè´ Professor</option>
                                <option value="FUNCIONARIO">üëî Funcion√°rio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email">Email (opcional)</label>
                            <input type="email" id="email" name="email" 
                                   placeholder="Ex: joao@email.com">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">‚úÖ Cadastrar Usu√°rio</button>
                </form>
            </section>

            <section class="list-section">
                <h3>üë• Usu√°rios Cadastrados ({{ usuarios|length }})</h3>
                {% if usuarios %}
                <div class="table-container">
                    <table id="tabelaUsuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Matr√≠cula</th>
                                <th>Tipo</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Data Registro</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios %}
                            <tr>
                                <td><strong>#{{ usuario.id }}</strong></td>
                                <td>{{ usuario.nome }}</td>
                                <td><code>{{ usuario.matricula }}</code></td>
                                <td>
                                    <span class="badge badge-{{ usuario.tipo.value.lower() }}">
                                        {% if usuario.tipo.value == 'ALUNO' %}üéì{% elif usuario.tipo.value == 'PROFESSOR' %}üë®‚Äçüè´{% else %}üëî{% endif %}
                                        {{ usuario.tipo.value }}
                                    </span>
                                </td>
                                <td>{{ usuario.email or '‚Äî' }}</td>
                                <td>
                                    <span class="badge badge-status-{{ usuario.status.value.lower() }}">
                                        {{ usuario.status.value }}
                                    </span>
                                </td>
                                <td>{{ usuario.dataRegistro[:10] }}</td>
                                <td>
                                    <button class="btn btn-small btn-danger" 
                                            onclick="removerUsuario({{ usuario.id }},'{{ usuario.nome }}')">
                                        üóëÔ∏è Remover
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>üì≠ Nenhum usu√°rio cadastrado ainda.</p>
                </div>
                {% endif %}
            </section>
        </div>

        <!-- TAB: LIVROS -->
        <div id="tab-livros" class="tab-content">
            <section class="form-section">
                <h3>üìò Cadastrar Livro</h3>
                <form id="formLivro">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="livro_id">ID *</label>
                            <input type="number" id="livro_id" required min="1" placeholder="Ex: 1">
                        </div>
                        <div class="form-group">
                            <label for="livro_titulo">T√≠tulo *</label>
                            <input type="text" id="livro_titulo" required placeholder="Ex: Dom Casmurro">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="livro_autor">Autor *</label>
                            <input type="text" id="livro_autor" required placeholder="Ex: Machado de Assis">
                        </div>
                        <div class="form-group">
                            <label for="livro_estoque">Estoque *</label>
                            <input type="number" id="livro_estoque" required min="0" placeholder="Ex: 3">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">üì• Cadastrar Livro</button>
                </form>
            </section>

            <section class="list-section">
                <h3>üìö Cat√°logo de Livros</h3>
                <div class="table-container">
                    <table id="tabelaLivros">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√≠tulo</th>
                                <th>Autor</th>
                                <th>Estoque</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- TAB: EMPR√âSTIMOS -->
        <div id="tab-emprestimos" class="tab-content">
            <section class="form-section">
                <h3>üîó Empr√©stimo / Devolu√ß√£o</h3>
                <form id="formEmprestimo">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loan_user_id">Usu√°rio ID *</label>
                            <input type="number" id="loan_user_id" required min="1" placeholder="Ex: 1">
                        </div>
                        <div class="form-group">
                            <label for="loan_book_id">Livro ID *</label>
                            <input type="number" id="loan_book_id" required min="1" placeholder="Ex: 1">
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" onclick="criarEmprestimo()">üìó Emprestar</button>
                        <button type="button" class="btn" onclick="registrarDevolucao()">‚Ü©Ô∏è Devolver</button>
                    </div>
                </form>
            </section>

            <section class="list-section">
                <h3>üìù Empr√©stimos Registrados</h3>
                <div class="table-container">
                    <table id="tabelaLoans">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usu√°rio</th>
                                <th>Livro</th>
                                <th>Emprestado em</th>
                                <th>Devolvido em</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- TAB: RELAT√ìRIOS -->
        <div id="tab-relatorios" class="tab-content">
            <section class="form-section">
                <h3>üìä Relat√≥rios do Sistema</h3>
                <div class="form-row">
                    <button type="button" class="btn btn-primary" onclick="carregarRelatorioLivros()">
                        üìö Livros Mais Emprestados
                    </button>
                    <button type="button" class="btn btn-primary" onclick="carregarRelatorioUsuarios()">
                        üë• Usu√°rios Mais Ativos
                    </button>
                    <button type="button" class="btn btn-primary" onclick="carregarStatusAcervo()">
                        üìä Status do Acervo
                    </button>
                    <button type="button" class="btn btn-primary" onclick="carregarRelatorioDetalhado()">
                        üìã Empr√©stimos Detalhados
                    </button>
                </div>
            </section>

            <section class="list-section">
                <h3>Resultados</h3>
                <div id="relatorios-container"></div>
            </section>
        </div>

        <footer>
            <p>üéì Sistema de Biblioteca Integrado - TecLearn TABAJARA</p>
            <p>Desenvolvido com integra√ß√£o de m√∫ltiplos m√≥dulos</p>
        </footer>
    </div>

    <script>
        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Carregar dados da aba ao abrir
            if (tabName === 'livros') carregarLivros();
            if (tabName === 'emprestimos') carregarLoans();
        }

        // ========== USU√ÅRIOS ==========
        
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dados = {
                nome: document.getElementById('nome').value.trim(),
                matricula: document.getElementById('matricula').value.trim(),
                tipo: document.getElementById('tipo').value,
                email: document.getElementById('email').value.trim() || null
            };
            
            try {
                const response = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                if (response.ok) {
                    const usuario = await response.json();
                    mostrarMensagem(`‚úÖ Usu√°rio "${usuario.nome}" cadastrado com sucesso!`, 'sucesso');
                    document.getElementById('formCadastro').reset();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const erro = await response.json();
                    mostrarMensagem(`‚ùå Erro: ${erro.erro}`, 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao cadastrar usu√°rio. Tente novamente.', 'erro');
            }
        });
        
        async function removerUsuario(id, nome) {
            if (!confirm(`‚ö†Ô∏è Deseja realmente remover o usu√°rio "${nome}"?`)) return;
            
            try {
                const response = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    mostrarMensagem(`‚úÖ Usu√°rio "${nome}" removido com sucesso!`, 'sucesso');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const erro = await response.json();
                    mostrarMensagem(`‚ùå Erro: ${erro.erro}`, 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao remover usu√°rio.', 'erro');
            }
        }

        // ========== LIVROS ==========
        
        async function carregarLivros() {
            try {
                const r = await fetch('/api/livros');
                const livros = await r.json();
                const tbody = document.querySelector('#tabelaLivros tbody');
                tbody.innerHTML = '';
                livros.forEach(l => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${l.id}</td>
                        <td>${l.titulo}</td>
                        <td>${l.autor}</td>
                        <td>${l.estoque}</td>
                        <td>${l.status}</td>
                        <td><button class="btn btn-small btn-danger" onclick="removerLivro(${l.id})">üóëÔ∏è Remover</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {}
        }

        document.getElementById('formLivro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dados = {
                id: parseInt(document.getElementById('livro_id').value, 10),
                titulo: document.getElementById('livro_titulo').value.trim(),
                autor: document.getElementById('livro_autor').value.trim(),
                estoque: parseInt(document.getElementById('livro_estoque').value, 10)
            };
            try {
                const r = await fetch('/api/livros', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (r.ok) {
                    mostrarMensagem('‚úÖ Livro cadastrado!', 'sucesso');
                    e.target.reset();
                    carregarLivros();
                } else {
                    const err = await r.json();
                    mostrarMensagem(`‚ùå Erro: ${err.erro}`, 'erro');
                }
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao cadastrar livro.', 'erro');
            }
        });

        async function removerLivro(id) {
            if (!confirm('Remover livro #' + id + '?')) return;
            const r = await fetch('/api/livros/' + id, { method: 'DELETE' });
            if (r.ok) {
                mostrarMensagem('‚úÖ Livro removido!', 'sucesso');
                carregarLivros();
            } else {
                const err = await r.json();
                mostrarMensagem(`‚ùå Erro: ${err.erro}`, 'erro');
            }
        }

        // ========== EMPR√âSTIMOS ==========
        
        async function carregarLoans() {
            try {
                const r = await fetch('/api/emprestimos');
                const loans = await r.json();
                const tbody = document.querySelector('#tabelaLoans tbody');
                tbody.innerHTML = '';
                loans.forEach(l => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${l.loan_id}</td>
                        <td>${l.user_id}</td>
                        <td>${l.book_id}</td>
                        <td>${(l.borrowed_at || '').replace('T',' ').slice(0,19)}</td>
                        <td>${l.returned_at ? l.returned_at.replace('T',' ').slice(0,19) : '‚Äî'}</td>
                        <td>${l.returned_at ? '<span class="badge">Devolvido</span>' : '<span class="badge" style="background:#fef3c7;color:#92400e">Em curso</span>'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {}
        }

        async function criarEmprestimo() {
            const dados = {
                user_id: parseInt(document.getElementById('loan_user_id').value, 10),
                book_id: parseInt(document.getElementById('loan_book_id').value, 10)
            };
            try {
                const r = await fetch('/api/emprestimos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (r.ok) {
                    mostrarMensagem('‚úÖ Empr√©stimo registrado!', 'sucesso');
                    carregarLivros();
                    carregarLoans();
                } else {
                    const err = await r.json();
                    mostrarMensagem(`‚ùå Erro: ${err.erro}`, 'erro');
                }
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao registrar empr√©stimo.', 'erro');
            }
        }

        async function registrarDevolucao() {
            const dados = {
                user_id: parseInt(document.getElementById('loan_user_id').value, 10),
                book_id: parseInt(document.getElementById('loan_book_id').value, 10)
            };
            try {
                const r = await fetch('/api/devolucoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                if (r.ok) {
                    mostrarMensagem('‚úÖ Devolu√ß√£o registrada!', 'sucesso');
                    carregarLivros();
                    carregarLoans();
                } else {
                    const err = await r.json();
                    mostrarMensagem(`‚ùå Erro: ${err.erro}`, 'erro');
                }
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao registrar devolu√ß√£o.', 'erro');
            }
        }

        // ========== RELAT√ìRIOS ==========
        
        async function carregarRelatorioLivros() {
            try {
                const r = await fetch('/api/relatorios/livros-mais-emprestados');
                const data = await r.json();
                const container = document.getElementById('relatorios-container');
                container.innerHTML = '<h4>üìö Livros Mais Emprestados</h4>';
                if (data.length === 0) {
                    container.innerHTML += '<p>Nenhum empr√©stimo registrado ainda.</p>';
                    return;
                }
                let html = '<table><thead><tr><th>T√≠tulo</th><th>Autor</th><th>Total</th></tr></thead><tbody>';
                data.forEach(item => {
                    html += `<tr><td>${item.titulo}</td><td>${item.autor}</td><td><strong>${item.totalEmprestimos}</strong></td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML += html;
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao carregar relat√≥rio.', 'erro');
            }
        }

        async function carregarRelatorioUsuarios() {
            try {
                const r = await fetch('/api/relatorios/usuarios-mais-ativos');
                const data = await r.json();
                const container = document.getElementById('relatorios-container');
                container.innerHTML = '<h4>üë• Usu√°rios Mais Ativos</h4>';
                if (data.length === 0) {
                    container.innerHTML += '<p>Nenhum empr√©stimo registrado ainda.</p>';
                    return;
                }
                let html = '<table><thead><tr><th>Nome</th><th>Matr√≠cula</th><th>Total</th></tr></thead><tbody>';
                data.forEach(item => {
                    html += `<tr><td>${item.nome}</td><td>${item.matricula}</td><td><strong>${item.totalEmprestimos}</strong></td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML += html;
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao carregar relat√≥rio.', 'erro');
            }
        }

        async function carregarStatusAcervo() {
            try {
                const r = await fetch('/api/relatorios/status-acervo');
                const data = await r.json();
                const container = document.getElementById('relatorios-container');
                container.innerHTML = '<h4>üìä Status do Acervo</h4>';
                container.innerHTML += `
                    <div class="stats-section">
                        <div class="stat-card"><div class="stat-number">${data.total}</div><div class="stat-label">Total</div></div>
                        <div class="stat-card"><div class="stat-number">${data.disponivel}</div><div class="stat-label">Dispon√≠veis</div></div>
                        <div class="stat-card"><div class="stat-number">${data.emprestado}</div><div class="stat-label">Emprestados</div></div>
                    </div>
                `;
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao carregar relat√≥rio.', 'erro');
            }
        }

        async function carregarRelatorioDetalhado() {
            try {
                const r = await fetch('/api/relatorios/emprestimos-detalhado');
                const data = await r.json();
                const container = document.getElementById('relatorios-container');
                container.innerHTML = '<h4>üìã Empr√©stimos Detalhados</h4>';
                if (data.length === 0) {
                    container.innerHTML += '<p>Nenhum empr√©stimo registrado ainda.</p>';
                    return;
                }
                let html = '<table><thead><tr><th>ID</th><th>Usu√°rio</th><th>Livro</th><th>Status</th><th>Data Empr√©stimo</th><th>Data Devolu√ß√£o</th></tr></thead><tbody>';
                data.forEach(item => {
                    html += `<tr>
                        <td>#${item.loan_id}</td>
                        <td>${item.usuario.nome}<br><small>${item.usuario.matricula}</small></td>
                        <td>${item.livro.titulo}<br><small>${item.livro.autor}</small></td>
                        <td>${item.status === 'Devolvido' ? '<span class="badge">Devolvido</span>' : '<span class="badge" style="background:#fef3c7;color:#92400e">Em curso</span>'}</td>
                        <td>${(item.borrowed_at || '').replace('T',' ').slice(0,19)}</td>
                        <td>${item.returned_at ? item.returned_at.replace('T',' ').slice(0,19) : '‚Äî'}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML += html;
            } catch (e) {
                mostrarMensagem('‚ùå Erro ao carregar relat√≥rio.', 'erro');
            }
        }

        // Utilit√°rios
        
        function mostrarMensagem(texto, tipo) {
            const div = document.getElementById('mensagem');
            div.textContent = texto;
            div.className = `mensagem ${tipo}`;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            carregarLivros();
            carregarLoans();
        });
    </script>
</body>
</html>

